<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>PITFALL</title>
    <style>
        body, html {
            width: 100%;
            height: 100%;
            overflow: hidden;
            margin: 0;
            padding: 0;
        }

        #game {
            width:32em;
            height:48em;
            margin:auto;

            font-size: 1em;
            line-height: 1em;
            
            position: relative;
        }
    </style>
</head>
<body>

<!--
    An hour-long project based on the classic DOS game. 

    Some tinkering an improvments made over a train journey. 
-->

    
    <pre id="game"></pre>

<script>

var game = {
    speed : 100,
    width: 56,
    height: 46,
    score: 0,
    tick: 0,
    moves : 0,
    gap : .5,
    hits: 3,
    level : 1
}

var characters = {
    wall : '▓',
    hole : ' ',
    man : '☺',
    deadMan : '☹',
    cherry : '$'
}

var currentKey = false; // false || -1 / +1
var manPosition = game.width / 2;
var gapWidth = game.width * game.gap;
var gapOffset = gapWidth / 2;
var gapOffsetVaiance = 2;
var wallArray = makeInitalWallArray();

var textArea = document.querySelector('#game');

function makeInitalWallArray() {
    var top = Array
                .apply(0, Array(game.height - 10))
                .map(function() { return [0,game.width] })
    var bottom = Array
                .apply(0, Array(10))
                .map(function() { return [gapOffset,gapWidth] })
    
    return top.concat(bottom)
        
}

function render() {

    var i = 0;
    var outputArray = [];
    var newOffset = Math.random() > .5 ? gapOffset + gapOffsetVaiance : gapOffset - gapOffsetVaiance;
    var endGame = false;

    function drawWall(gapOffset, gapWidth) {
        var go = gapOffset;
        var gw = gapWidth;
        var line = "";
            line += Array(go).join(characters.wall);
            line += Array(gw).join(characters.hole);
            line += Array(game.width - go - gw).join(characters.wall);

        return line;
    }

    // difficulty
    levelCheck();

    // scores
    game.tick++;

    // move guy
    if(currentKey && manPosition + currentKey > 0 && manPosition + currentKey < game.width) {
        manPosition += currentKey;
    }

    // render last state
    for (i; i < wallArray.length; i++) {
        outputArray[i] = drawWall(wallArray[i][0], wallArray[i][1]);
    };

    // inject guy
    if(outputArray[game.height / 2].charAt(manPosition) !== characters.hole) {
        game.hits--;
        outputArray[game.height / 2] = outputArray[game.height / 2].replaceAt(manPosition, characters.deadMan);
        if(game.hits === 0) {
            endGame = true;
            outputArray.push('xxx GAME OVER xxx');
        }
    } else {
        outputArray[game.height / 2] = outputArray[game.height / 2].replaceAt(manPosition, characters.man);
    }

    outputArray.push('\nLIVES: '+ game.hits + " " + 'LEVEL : ' + game.level + " " + 'SCORE : ' + game.tick);

    // draw text
    textArea.textContent = outputArray.join('\n');

    // new walls
    wallArray.shift();

    if(newOffset < 1 || newOffset + gapWidth >= game.width - 1) {
        wallArray.push(wallArray[wallArray.length - 1]);
    } else {
        wallArray.push([newOffset, gapWidth]);
    }
    gapOffset = wallArray[wallArray.length - 1][0];

    if(!endGame) {
        // repeat
        window.setTimeout(render, game.speed);
    }
}

function levelCheck() {
    if(game.tick > 0 && game.tick % 100 == 0 && gapWidth > 8) {
        gapWidth -= 2;
        game.level++;
        game.score += 20;
    }

    if(game.tick > 0 && game.tick % 50 == 0 && game.speed > 10) {
        game.speed = game.speed * .95;
        game.level++;
        game.score += 10;
    }
}

String.prototype.replaceAt=function(index, character) {
    return this.substr(0, index) + character + this.substr(index+character.length);
}

window.addEventListener('keydown', function(e) {
    
    var kk = e.keyCode;

    // left
    if(kk == 37 || kk == 65) {
        currentKey = -1;
    }

    // right
    if(kk == 39 || kk == 68) {
        currentKey = +1;
    }

});

window.addEventListener('keyup', function(e) {
    currentKey = false;
});

render();

</script>
</body>
</html>